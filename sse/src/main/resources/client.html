<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>SSE Client Demo</title>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background: #f6f7f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: #ffffff;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e3e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.06);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: red;
        }

        .dot.connected {
            background: #2ecc71;
        }

        main {
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }

        .message {
            background: white;
            padding: 14px 16px;
            border-radius: 6px;
            border-left: 4px solid #4a8af4;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 13px;
        }

        footer {
            padding: 12px 16px;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            background: #f0f1f3;
            border-top: 1px solid #ddd;
        }

        .controls button {
            margin-left: 8px;
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        .controls button.active {
            border-color: #4a8af4;
            color: #4a8af4;
            font-weight: 600;
        }
    </style>
</head>

<body>
<header>
    <div class="status">
        <div id="statusDot" class="dot"></div>
        <span id="statusText">Disconnected</span>
    </div>
    <div class="controls">
        Backend:
        <button id="btnRedis" class="active">Redis (/sse/redis)</button>
        <button id="btnKafka">Kafka (/sse/kafka)</button>
        <button id="btnKafkaReactor">Kafka (/sse/kafka/reactor)</button>
    </div>
</header>

<main id="messages"></main>

<footer>
    <div>
        Last Event ID: <span id="lastId">None</span>
    </div>
    <div>
        Backend: <span id="backendLabel">Redis</span>
    </div>
</footer>

<script>
    class SSEClient {
        constructor(url) {
            this.url = url;
            this.eventSource = null;
            this.backoff = 1000;
            this.maxBackoff = 15000;
            this.lastEventId = localStorage.getItem(this.storageKey()) || null;
            this.retryTimeoutId = null;
            this.closed = false;
            this.connect();
        }

        storageKey() {
            // backend별로 lastEventId를 분리 저장
            return "lastEventId:" + this.url;
        }

        connect() {
            if (this.closed) return;

            const url = this.lastEventId
                ? `${this.url}?lastEventId=${encodeURIComponent(this.lastEventId)}`
                : this.url;

            this.eventSource = new EventSource(url);

            this.eventSource.onopen = () => {
                if (this.closed) return;
                this.setStatus(true);
                this.backoff = 1000;
            };

            this.eventSource.onmessage = (event) => {
                if (this.closed) return;

                if (event.lastEventId) {
                    this.lastEventId = event.lastEventId;
                    localStorage.setItem(this.storageKey(), this.lastEventId);
                    document.getElementById("lastId").innerText = this.lastEventId;
                }

                this.addMessage(event.data);
            };

            this.eventSource.onerror = () => {
                if (this.closed) return;

                this.setStatus(false);
                this.eventSource.close();

                if (this.retryTimeoutId) {
                    clearTimeout(this.retryTimeoutId);
                }

                this.retryTimeoutId = setTimeout(() => {
                    this.connect();
                }, this.backoff);

                this.backoff = Math.min(this.backoff * 2, this.maxBackoff);
            };
        }

        addMessage(text) {
            const container = document.getElementById("messages");
            const div = document.createElement("div");
            div.className = "message";

            // 서버에서 SseEvent JSON 내려온다고 가정
            try {
                const obj = JSON.parse(text);
                const ulid = obj.ulid || "NO-ULID";
                const msg = obj.message || text;
                const createdAt = obj.createdAt || "";
                div.textContent = `[${ulid}] ${msg} (${createdAt})`;
            } catch (e) {
                div.textContent = text;
            }

            // 새 메시지 위에서부터
            container.insertBefore(div, container.firstChild);
        }

        setStatus(connected) {
            const dot = document.getElementById("statusDot");
            const text = document.getElementById("statusText");

            if (connected) {
                dot.classList.add("connected");
                text.textContent = "Connected";
            } else {
                dot.classList.remove("connected");
                text.textContent = "Disconnected";
            }
        }

        close() {
            this.closed = true;

            if (this.retryTimeoutId) {
                clearTimeout(this.retryTimeoutId);
                this.retryTimeoutId = null;
            }

            if (this.eventSource) {
                this.eventSource.onopen = null;
                this.eventSource.onmessage = null;
                this.eventSource.onerror = null;
                this.eventSource.close();
            }

            this.setStatus(false);
        }
    }

    const host = "http://localhost:8080";
    let client = new SSEClient(host + "/sse/redis"); // 기본 Redis

    function clearMessages() {
        const container = document.getElementById("messages");
        container.innerHTML = "";
    }

    function switchBackend(backend) {
        if (client) {
            client.close();
        }

        clearMessages();

        const btnRedis = document.getElementById("btnRedis");
        const btnKafka = document.getElementById("btnKafka");
        const btnKafkaReactor = document.getElementById("btnKafkaReactor");
        const backendLabel = document.getElementById("backendLabel");

        btnRedis.classList.remove("active");
        btnKafka.classList.remove("active");
        btnKafkaReactor.classList.remove("active");

        let url;
        if (backend === "redis") {
            btnRedis.classList.add("active");
            backendLabel.textContent = "Redis";
            url = "/sse/redis";
        } else if (backend === "kafka") {
            btnKafka.classList.add("active");
            backendLabel.textContent = "Kafka";
            url = "/sse/kafka";
        } else if (backend === "kafkaReactor") {
            btnKafkaReactor.classList.add("active");
            backendLabel.textContent = "Kafka (Reactor)";
            url = "/sse/kafka/reactor";
        }

        client = new SSEClient(host + url);

        // backend 바꿀 때 해당 backend용 lastEventId 표기
        const lastId = localStorage.getItem(client.storageKey());
        document.getElementById("lastId").innerText = lastId || "None";
    }

    document.getElementById("btnRedis").onclick = () => switchBackend("redis");
    document.getElementById("btnKafka").onclick = () => switchBackend("kafka");
    document.getElementById("btnKafkaReactor").onclick = () => switchBackend("kafkaReactor");
</script>

</body>
</html>
